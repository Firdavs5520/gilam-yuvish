<!DOCTYPE html>
<html lang="uz">

<head>
  <meta charset="UTF-8" />
  <title>Чек</title>

  <link rel="icon" type="image/png"
    href="https://peculiar-azure-xpdzzqfo3r.edgeone.app/Skrinshot_2026-01-03_175603-removebg-preview.png" />

  <style>
    @media print {
      @page {
        size: 58mm auto;
        margin: 0;
      }
    }

    body {
      font-family: monospace;
      width: 58mm;
      margin: 0;
      padding: 6px;
      font-size: 12px;
      color: #000;
    }

    .center {
      text-align: center;
    }

    .bold {
      font-weight: bold;
    }

    .right {
      text-align: right;
    }

    .line {
      border-top: 1px dashed #000;
      margin: 6px 0;
    }

    .small {
      font-size: 11px;
      line-height: 1.3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    td {
      padding: 2px 0;
    }
  </style>
</head>

<body>
  <div id="out"></div>

  <script>
    const API = "https://gilam-yuvish-backend.onrender.com";

    const params = new URLSearchParams(location.search);
    const id = params.get("id");

    if (!id) {
      document.getElementById("out").innerHTML =
        "<div class='center'>Нет данных</div>";
      throw new Error("ID yo‘q");
    }

    fetch(API + "/orders/" + id)
      .then(r => r.json())
      .then(d => {
        if (!d || !Array.isArray(d.items)) {
          document.getElementById("out").innerHTML =
            "<div class='center'>Нет данных</div>";
          return;
        }

        const PRICE_PER_M2 = 15000;
        const PRICE_LABEL = 15;

        const date = new Date(d.createdAt).toLocaleString("ru-RU", {
          day: "2-digit",
          month: "long",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        let rows = "";
        let total = 0;

        d.items.forEach(i => {
          const l = Number(i.l) || 0;
          const w = Number(i.w) || 0;
          const m2 = l * w;
          const sum = m2 * PRICE_PER_M2;
          total += sum;

          rows += `
            <tr>
              <td>КОВЕР</td>
              <td>${l}x${w} м²</td>
              <td class="right">${PRICE_LABEL}</td>
              <td class="right">${sum.toLocaleString()}</td>
            </tr>
          `;
        });

        document.getElementById("out").innerHTML = `
          <div class="center">
            <img src="https://peculiar-azure-xpdzzqfo3r.edgeone.app/Skrinshot_2026-01-03_175603-removebg-preview.png" width="110"><br>
            <div class="bold">ФАБРИКА ЧИСТКИ КОВРОВ</div>
            <div class="small">
              Ул. Буюк Ипак Йули 62А<br>
              Ташкент<br>
              Тел: 71 203 82 82
            </div>
          </div>

          <div class="line"></div>

          <div class="center bold">${date}</div>

          <div class="line"></div>

          <div class="bold">${d.name}</div>
          <div class="small">${d.address || ""}</div>
          <div class="small">${d.phone || ""}</div>

          <div class="line"></div>

          <table>
            <tr class="bold">
              <td>Наим.</td>
              <td>Размер</td>
              <td class="right">Цена</td>
              <td class="right">Сумма</td>
            </tr>
            ${rows}
          </table>

          <div class="line"></div>

          <div class="bold">ИТОГО: ${total.toLocaleString()} сум</div>
          <div>Оплачено: ${(Number(d.paid) || 0).toLocaleString()} сум</div>
          <div>Тип оплаты: ${d.paymentType || "-"}</div>

          <div class="line"></div>

          <div class="small">
            <b>ВНИМАНИЕ ЗАКАЗЧИКА!</b><br>
            Химчистка снимает с себя ответственность за скрытые дефекты изделия,
            сильный износ и отсутствие маркировки.<br>
            Претензии принимаются только при получении заказа.
          </div>

          <div class="line"></div>

          <div class="small">
            Подпись клиента: ______________________
          </div>
        `;

        setTimeout(() => window.print(), 300);
      })
      .catch(() => {
        document.getElementById("out").innerHTML =
          "<div class='center'>Нет данных</div>";
      });
  </script>
</body>

</html>